<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner</title>
    <link rel="stylesheet" href="css/styling.css">
</head>
<body>
<div class="container">
    <h1>Scan QR Code</h1>

    <!-- Display logged-in checkpoint -->
    <p id="loggedInAs"></p>

    <div id="reader" style="width:100%; max-width:400px;"></div>
    <p id="scanStatus">Press "Scan & Send" to start scanning.</p>
    <button id="scanSendButton">Scan & Send</button>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
    document.addEventListener("DOMContentLoaded", async function() {
        // Retrieve the checkpoint name instead of the password
        const checkpointName = localStorage.getItem("usedCheckpointName");
        if (!checkpointName) {
            window.location.href = "index.html"; // redirect if not logged in
            return;
        }

        const loggedInDisplay = document.getElementById("loggedInAs");
        loggedInDisplay.textContent = `Logged in as ${checkpointName}`;

        const scanStatus = document.getElementById("scanStatus");
        const scanSendButton = document.getElementById("scanSendButton");
        let sent = false;

        scanSendButton.addEventListener("click", async () => {
            if (sent) return; // prevent multiple sends
            scanStatus.style.color = "black";
            scanStatus.textContent = "Scanning...";

            const html5QrCode = new Html5Qrcode("reader");

            try {
                const devices = await Html5Qrcode.getCameras();
                if (!devices || !devices.length) {
                    scanStatus.style.color = "red";
                    scanStatus.textContent = "No camera found";
                    return;
                }

                const cameraId = devices[0].id;

                html5QrCode.start(
                    { deviceId: { exact: cameraId } },
                    { fps: 10, qrbox: 250 },
                    (decodedText) => {
                        scanStatus.style.color = "green";
                        scanStatus.textContent = `QR Code detected: ${decodedText}`;

                        // Use checkpointName instead of password in the URL
                        const apiUrl = `https://api.myled.tk/${encodeURIComponent(checkpointName)}/${encodeURIComponent(decodedText)}`;

                        fetch(apiUrl)
                            .then(response => response.json())
                            .then(data => {
                                console.log("Server response:", data);
                                scanStatus.textContent = `Scan submitted: ${decodedText}`;
                                sent = true;
                            })
                            .catch(err => {
                                console.error("Error sending scan:", err);
                                scanStatus.style.color = "red";
                                scanStatus.textContent = "Error sending scan";
                            });

                        // Stop scanner after first successful scan
                        html5QrCode.stop().catch(err => console.error("Failed to stop scanner", err));
                    },
                    (errorMessage) => {
                        console.log("Scan error (ignored):", errorMessage);
                    }
                );
            } catch (err) {
                console.error("Scanner initialization error:", err);
                scanStatus.style.color = "red";
                scanStatus.textContent = "Failed to start the scanner";
            }
        });
    });
</script>
</body>
</html>
